<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lenguaje controlado – Tarjetas por término padre</title>
  <style>
    :root {
      --bg: #f6f8fb;
      --panel: #ffffff;
      --muted: #5f6c7b;
      --text: #16202a;
      --accent: #4f46e5; /* índigo */
      --border: #e6eaf0;
      --shadow: 0 4px 14px rgba(22,32,42,.06);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial; background: var(--bg); color: var(--text); }

    header { position: sticky; top: 0; z-index: 5; backdrop-filter: blur(8px); background: rgba(246,248,251,.85); border-bottom: 1px solid var(--border); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1 { margin: 0; font-size: 22px; letter-spacing: .2px; }
    .sub { color: var(--muted); font-size: 13px; margin-top: 4px; }

    .toolbar { display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: center; margin-top: 12px; }
    .badge { padding: 4px 8px; border: 1px solid var(--border); border-radius: 999px; color: var(--muted); font-size: 12px; background: #fff; }
    input[type="text"] { background: #fff; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; font-size: 14px; outline: none; box-shadow: var(--shadow); }
    input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(79,70,229,.12); }
    button { background: #fff; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 8px 12px; font-size: 14px; cursor: pointer; box-shadow: var(--shadow); }
    button:hover { border-color: var(--accent); }

    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 14px; margin-top: 16px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 10px; }

    .term { display: flex; align-items: center; justify-content: space-between; gap: 8px; font-weight: 800; font-size: 18px; cursor: pointer; padding: 8px 10px; border-radius: 12px; border: 1px solid transparent; }
    .term:hover { background: #eef0ff; border-color: rgba(79,70,229,.35); }
    .term .chev { font-size: 12px; color: var(--muted); }

    .def { color: #2d3748; line-height: 1.5; white-space: pre-wrap; }
    .source { color: var(--muted); font-size: 13px; }
    .link a { color: var(--accent); text-decoration: none; }
    .link a:hover { text-decoration: underline; }

    .children { display: none; border-top: 1px dashed var(--border); padding-top: 10px; margin-top: 6px; }
    .child { padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; margin-top: 10px; background: #fbfbfe; }
    .child-title { font-weight: 700; }
    .child-def { color: #3a4452; font-size: 14px; margin-top: 4px; white-space: pre-wrap; }

    .status { color: var(--muted); font-size: 12px; }
    .empty { color: var(--muted); text-align: center; padding: 24px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Lenguaje controlado – Tarjetas por término padre</h1>
      <div class="sub">Título = <strong>termino_padre</strong>. Al hacer clic, se despliegan los <strong>terminos_hijo</strong> asociados. La definición del padre proviene de la fila con <code>termino_hijo = 0</code>.</div>

      <div class="toolbar">
        <div class="status"><span id="count">0</span> padres • <span id="fields">0</span> campos</div>
        <input id="q" type="text" placeholder="Buscar por padre/hijo, definición o fuente…" />
        <button id="reload">Recargar</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="cards" class="cards"></div>
    <div id="empty" class="empty" style="display:none;">Sin resultados</div>
    <div class="status" style="margin-top:10px;">Fuente JSON: <span id="dataUrl"></span></div>
  </main>

  <script>
    // Ruta del JSON
    const DATA_URL = './lenguaje.json';

    // Estado
    let RAW = [];
    let COLUMNS = [];
    const FIELD = { parent:null, child:null, definition:null, source:null, link:null };

    // Helpers
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const norm = (s) => String(s||'')
      .toLowerCase()
      .normalize('NFD').replace(/\p{Diacritic}/gu,'')
      .replace(/[^a-z0-9]+/g,'_');

    function findField(patterns) {
      const cols = COLUMNS.map(c => [c, norm(c)]);
      // prioridad: match exacto; luego includes
      for (const p of patterns) {
        const exact = cols.find(([orig,n]) => n === norm(p));
        if (exact) return exact[0];
      }
      for (const p of patterns) {
        const pn = norm(p);
        const cands = cols.filter(([_,n]) => n.includes(pn));
        if (cands.length) {
          cands.sort((a,b) => a[1].length - b[1].length);
          return cands[0][0];
        }
      }
      return null;
    }

    function detectFields() {
      FIELD.parent     = findField(['termino_padre','término_padre','padre']);
      FIELD.child      = findField(['termino_hijo','término_hijo','hijo']);
      FIELD.definition = findField(['definicion_termino','definicion termino','definicion','definicion_termino2']);
      FIELD.source     = findField(['fuente_termino','fuente termino','fuente','fuente_termino_2']);
      FIELD.link       = findField(['link_fuente_termino','link fuente termino','enlace_fuente','url_fuente','link_fuente_termino_']);
    }

    function prettyChildName(v) {
      const s = String(v ?? '').trim();
      // elimina prefijo numérico tipo "1 ", "2.", "3)" si existe
      return s.replace(/^\s*\d+[\s\-.:)]*/,'').trim() || s || '(término)';
    }

    function groupByParent(rows) {
      const map = new Map();
      for (const r of rows) {
        const p = String(r?.[FIELD.parent] ?? '').trim();
        if (!p) continue;
        if (!map.has(p)) map.set(p, { name:p, pDef:'', pSource:'', pLink:'', children:[] });
        const chVal = String(r?.[FIELD.child] ?? '').trim();
        const isParentRow = chVal === '0' || chVal === 0 || /^0(\.0+)?$/.test(chVal);
        if (isParentRow) {
          map.get(p).pDef = r?.[FIELD.definition] ?? map.get(p).pDef;
          map.get(p).pSource = r?.[FIELD.source] ?? map.get(p).pSource;
          map.get(p).pLink = r?.[FIELD.link] ?? map.get(p).pLink;
        } else {
          map.get(p).children.push({
            name: prettyChildName(chVal),
            def: r?.[FIELD.definition] ?? '',
            source: r?.[FIELD.source] ?? '',
            link: r?.[FIELD.link] ?? ''
          });
        }
      }
      // Ordena hijos por nombre
      for (const g of map.values()) g.children.sort((a,b)=> a.name.localeCompare(b.name,'es',{sensitivity:'base'}));
      return Array.from(map.values()).sort((a,b)=> a.name.localeCompare(b.name,'es',{sensitivity:'base'}));
    }

    function render(groups) {
      const container = $('#cards');
      container.innerHTML = '';

      if (!groups.length) {
        $('#empty').style.display = 'block';
        $('#count').textContent = '0';
        return;
      } else {
        $('#empty').style.display = 'none';
      }

      const frag = document.createDocumentFragment();
      for (const g of groups) {
        const card = document.createElement('div');
        card.className = 'card';

        const termBtn = document.createElement('div');
        termBtn.className = 'term';
        termBtn.innerHTML = `<span>${g.name}</span><span class="chev">▸</span>`;

        const defEl = document.createElement('div');
        defEl.className = 'def';
        if (g.pDef) defEl.textContent = g.pDef;

        const sourceEl = document.createElement('div');
        sourceEl.className = 'source';
        if (g.pSource) sourceEl.textContent = g.pSource;

        const linkEl = document.createElement('div');
        linkEl.className = 'link';
        if (typeof g.pLink === 'string' && /^https?:\/\//i.test(g.pLink)) {
          linkEl.innerHTML = `<a href="${g.pLink}" target="_blank" rel="noopener">Abrir fuente</a>`;
        } else if (String(g.pLink||'').length) {
          linkEl.textContent = String(g.pLink);
        }

        const childrenBox = document.createElement('div');
        childrenBox.className = 'children';

        if (g.children.length) {
          for (const ch of g.children) {
            const chDiv = document.createElement('div');
            chDiv.className = 'child';
            const chTitle = document.createElement('div');
            chTitle.className = 'child-title';
            chTitle.textContent = ch.name;
            const chDef = document.createElement('div');
            chDef.className = 'child-def';
            if (ch.def) chDef.textContent = ch.def;
            const chLink = document.createElement('div');
            chLink.className = 'link';
            if (typeof ch.link === 'string' && /^https?:\/\//i.test(ch.link)) chLink.innerHTML = `<a href="${ch.link}" target="_blank" rel="noopener">Abrir fuente</a>`;
            chDiv.append(chTitle);
            if (ch.def) chDiv.append(chDef);
            if (ch.link) chDiv.append(chLink);
            childrenBox.append(chDiv);
          }
        } else {
          const none = document.createElement('div');
          none.className = 'child';
          none.style.background = '#fff';
          none.style.borderStyle = 'dashed';
          none.textContent = 'No hay términos hijos';
          childrenBox.appendChild(none);
        }

        termBtn.addEventListener('click', () => {
          const chev = termBtn.querySelector('.chev');
          const isOpen = childrenBox.style.display === 'block';
          childrenBox.style.display = isOpen ? 'none' : 'block';
          chev.textContent = isOpen ? '▸' : '▾';
        });

        card.append(termBtn);
        if (g.pDef) card.append(defEl);
        if (g.pSource) card.append(sourceEl);
        if (g.pLink) card.append(linkEl);
        card.append(childrenBox);
        frag.append(card);
      }

      container.append(frag);
      $('#count').textContent = groups.length;
      $('#fields').textContent = COLUMNS.length;
    }

    function matchesQuery(g, q) {
      if (!q) return true;
      const t = q.toLowerCase().split(/\s+/).filter(Boolean);
      const pile = [g.name, g.pDef, g.pSource].join(' | ').toLowerCase() + ' | ' + g.children.map(c => (c.name + ' ' + (c.def||'')).toLowerCase()).join(' | ');
      return t.every(s => pile.includes(s));
    }

    function applySearch(groups) {
      const q = $('#q').value.trim();
      render(groups.filter(g => matchesQuery(g,q)));
    }

    async function loadData() {
      $('#dataUrl').textContent = DATA_URL;
      const res = await fetch(DATA_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      const arr = Array.isArray(json) ? json : (Array.isArray(json.items) ? json.items : (Array.isArray(json.data) ? json.data : []));
      RAW = arr;
      COLUMNS = Object.keys(arr[0] || {});
      detectFields();
      const groups = groupByParent(RAW);
      render(groups);
      $('#q').addEventListener('input', () => { clearTimeout(window.__t); window.__t = setTimeout(() => applySearch(groups), 160); });
    }

    // Init
    document.getElementById('reload').addEventListener('click', loadData);
    loadData().catch(err => { console.error(err); const e = document.getElementById('empty'); e.style.display = 'block'; e.textContent = 'Error cargando datos'; });
  </script>
</body>
</html>




