<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lenguaje controlado – Tarjetas</title>
  <style>
    :root {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --muted: #5f6c7b;
      --text: #1b2430;
      --accent: #6c5ce7; /* lila suave */
      --border: #e5e9f2;
      --shadow: 0 4px 12px rgba(27,36,48,.06);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial; background: var(--bg); color: var(--text); }

    header { position: sticky; top: 0; z-index: 5; backdrop-filter: blur(8px); background: rgba(247,248,251,.8); border-bottom: 1px solid var(--border); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1 { margin: 0; font-size: 22px; letter-spacing: .2px; }
    .sub { color: var(--muted); font-size: 13px; margin-top: 4px; }

    .toolbar { display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: center; margin-top: 12px; }
    .badge { padding: 4px 8px; border: 1px solid var(--border); border-radius: 999px; color: var(--muted); font-size: 12px; background: #fff; }
    input[type="text"] { background: #fff; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; font-size: 14px; outline: none; box-shadow: var(--shadow); }
    input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(108,92,231,.12); }
    button { background: #fff; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 8px 12px; font-size: 14px; cursor: pointer; box-shadow: var(--shadow); }
    button:hover { border-color: var(--accent); }

    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 14px; margin-top: 16px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 14px; box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 10px; }
    .term { display: inline-flex; align-items: center; gap: 8px; font-weight: 700; font-size: 16px; cursor: pointer; padding: 6px 8px; border-radius: 10px; border: 1px solid transparent; }
    .term:hover { background: #f0efff; border-color: rgba(108,92,231,.35); }
    .term .chev { font-size: 12px; color: var(--muted); }
    .def { color: #2d3643; line-height: 1.45; }
    .source { color: var(--muted); font-size: 13px; }
    .link a { color: var(--accent); text-decoration: none; }
    .link a:hover { text-decoration: underline; }

    .children { display: none; border-top: 1px dashed var(--border); padding-top: 10px; margin-top: 4px; }
    .child { padding: 8px 10px; border: 1px solid var(--border); border-radius: 10px; margin-top: 8px; background: #fbfbfe; }
    .child-title { font-weight: 600; }
    .child-def { color: #3a4452; font-size: 14px; margin-top: 4px; }

    .status { color: var(--muted); font-size: 12px; }
    .empty { color: var(--muted); text-align: center; padding: 24px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Lenguaje controlado – Tarjetas</h1>
      <div class="sub">Vista en tarjetas (claro). Haz clic en el término para desplegar sus términos hijos.</div>

      <div class="toolbar">
        <div class="status"><span id="count">0</span> elementos • <span id="fields">0</span> campos</div>
        <input id="q" type="text" placeholder="Buscar por término, definición o fuente…" />
        <button id="reload">Recargar</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="cards" class="cards"></div>
    <div id="empty" class="empty" style="display:none;">Sin resultados</div>
    <div class="status" style="margin-top:10px;">Fuente JSON: <span id="dataUrl"></span></div>
  </main>

  <script>
    // Configura la ruta de tu JSON aquí
    const DATA_URL = './lenguaje.json';

    // Estado
    let RAW = [];
    let COLUMNS = [];
    let INDEX_BY_NAME = new Map(); // nombre → [filas]
    let FIELD = { name: null, parent: null, definition: null, source: null, link: null };

    // Utilidades
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const norm = (s) => String(s||'')
      .toLowerCase()
      .normalize('NFD').replace(/\p{Diacritic}/gu,'')
      .replace(/[^a-z0-9]+/g,'_');

    function findField(patterns) {
      const cols = COLUMNS.map(c => [c, norm(c)]);
      for (const p of patterns) {
        const pn = norm(p);
        const cands = cols.filter(([_,n]) => n.includes(pn));
        if (cands.length) {
          cands.sort((a,b) => a[1].length - b[1].length);
          return cands[0][0];
        }
      }
      return null;
    }

    function detectFields() {
      FIELD.name = findField(['termino','término','nombre','concepto']) || findField(['termino_padre']);
      FIELD.parent = findField(['termino_padre','término_padre','padre','parent']);
      FIELD.definition = findField(['definicion_termino','definicion','definicion termino']);
      FIELD.source = findField(['fuente_termino','fuente termino','fuente']);
      FIELD.link = findField(['link_fuente_termino','enlace_fuente','url_fuente','link fuente']);
    }

    function indexByName() {
      INDEX_BY_NAME = new Map();
      for (const r of RAW) {
        const name = r?.[FIELD.name];
        const key = name==null ? '' : String(name).trim();
        if (!INDEX_BY_NAME.has(key)) INDEX_BY_NAME.set(key, []);
        INDEX_BY_NAME.get(key).push(r);
      }
    }

    function uniqueNames(list) {
      return Array.from(new Set(list.map(r => String(r?.[FIELD.name] ?? '').trim()))).filter(Boolean).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
    }

    function renderCards(rows) {
      const container = $('#cards');
      container.innerHTML = '';

      if (!rows.length) {
        $('#empty').style.display = 'block';
        $('#count').textContent = '0';
        return;
      } else {
        $('#empty').style.display = 'none';
      }

      const names = uniqueNames(rows);
      const frag = document.createDocumentFragment();

      for (const name of names) {
        const anyRow = (INDEX_BY_NAME.get(name) || [])[0] || {};
        const def = anyRow?.[FIELD.definition] ?? '';
        const source = anyRow?.[FIELD.source] ?? '';
        const link = anyRow?.[FIELD.link] ?? '';

        const card = document.createElement('div');
        card.className = 'card';

        const termBtn = document.createElement('div');
        termBtn.className = 'term';
        termBtn.innerHTML = `<span class="chev">▸</span><span>${name || '(sin nombre)'}</span>`;

        const defEl = document.createElement('div');
        defEl.className = 'def';
        defEl.textContent = def;

        const sourceEl = document.createElement('div');
        sourceEl.className = 'source';
        sourceEl.textContent = source;

        const linkEl = document.createElement('div');
        linkEl.className = 'link';
        if (typeof link === 'string' && /^https?:\/\//i.test(link)) {
          linkEl.innerHTML = `<a href="${link}" target="_blank" rel="noopener">Abrir fuente</a>`;
        } else if (String(link || '').length) {
          // si no es url pero hay contenido, lo mostramos plano
          linkEl.textContent = String(link);
        }

        const childrenBox = document.createElement('div');
        childrenBox.className = 'children';

        // Busca hijos: filas cuyo parent == este nombre
        let children = [];
        if (FIELD.parent) {
          children = RAW.filter(r => String(r?.[FIELD.parent] ?? '').trim() === name);
        }

        if (children.length) {
          for (const ch of children) {
            const chName = ch?.[FIELD.name] ?? '(término)';
            const chDef = ch?.[FIELD.definition] ?? '';
            const chDiv = document.createElement('div');
            chDiv.className = 'child';
            chDiv.innerHTML = `<div class="child-title">${chName}</div>` + (chDef ? `<div class="child-def">${chDef}</div>` : '');
            childrenBox.appendChild(chDiv);
          }
        } else {
          const none = document.createElement('div');
          none.className = 'child';
          none.style.background = '#fff';
          none.style.borderStyle = 'dashed';
          none.textContent = 'No hay términos hijos';
          childrenBox.appendChild(none);
        }

        termBtn.addEventListener('click', () => {
          const chev = termBtn.querySelector('.chev');
          const isOpen = childrenBox.style.display === 'block';
          childrenBox.style.display = isOpen ? 'none' : 'block';
          chev.textContent = isOpen ? '▸' : '▾';
        });

        card.append(termBtn);
        if (def) card.append(defEl);
        if (source) card.append(sourceEl);
        if (link) card.append(linkEl);
        card.append(childrenBox);
        frag.append(card);
      }

      container.append(frag);
      $('#count').textContent = names.length;
      $('#fields').textContent = COLUMNS.length;
    }

    function matchesSearch(r, q) {
      if (!q) return true;
      const t = q.toLowerCase().split(/\s+/).filter(Boolean);
      const pile = [FIELD.name, FIELD.definition, FIELD.source]
        .map(k => String(r?.[k] ?? '').toLowerCase()).join(' | ');
      return t.every(s => pile.includes(s));
    }

    function applySearch() {
      const q = $('#q').value.trim();
      const filtered = RAW.filter(r => matchesSearch(r, q));
      renderCards(filtered);
    }

    async function loadData() {
      $('#dataUrl').textContent = DATA_URL;
      const res = await fetch(DATA_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      const arr = Array.isArray(json) ? json : (Array.isArray(json.items) ? json.items : (Array.isArray(json.data) ? json.data : []));
      RAW = arr;
      COLUMNS = Object.keys(arr[0] || {});
      detectFields();
      indexByName();
      applySearch();
    }

    // UI events
    document.getElementById('q').addEventListener('input', () => { clearTimeout(window.__t); window.__t = setTimeout(applySearch, 150); });
    document.getElementById('reload').addEventListener('click', loadData);

    // Init
    loadData().catch(err => { console.error(err); document.getElementById('empty').style.display = 'block'; document.getElementById('empty').textContent = 'Error cargando datos'; });
  </script>
</body>
</html>



