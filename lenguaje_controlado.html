<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lenguaje controlado â€“ VisualizaciÃ³n (con bÃºsqueda y filtros)</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121821;
      --muted: #8aa0b3;
      --text: #e9eef3;
      --accent: #4da3ff;
      --ok: #37c297;
      --warn: #ffb020;
      --err: #ff5a5f;
      --border: #1f2a38;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }
    header { position: sticky; top: 0; z-index: 5; backdrop-filter: blur(8px); background: linear-gradient(180deg, rgba(11,15,20,.95), rgba(11,15,20,.65)); border-bottom: 1px solid var(--border); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1 { margin: 0; font-size: 20px; letter-spacing: .2px; }
    .sub { color: var(--muted); font-size: 12px; margin-top: 4px; }

    .toolbar { display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: center; margin-top: 12px; }
    .left { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .right { display: flex; gap: 8px; }
    .badge { padding: 4px 8px; border: 1px solid var(--border); border-radius: 999px; color: var(--muted); font-size: 12px; }
    .spacer { flex: 1; }
    button, select, input[type="text"] { background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 8px 12px; font-size: 14px; }
    button { cursor: pointer; }
    button:hover, select:hover, input[type="text"]:focus { border-color: var(--accent); outline: none; }

    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 12px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }

    .filters { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
    .filter-chip { display: flex; gap: 6px; align-items: center; padding: 6px; border: 1px solid var(--border); border-radius: 12px; }
    .filter-chip select, .filter-chip input { padding: 6px 8px; font-size: 13px; }
    .chip-del { background: transparent; border: 1px solid var(--border); border-radius: 8px; padding: 4px 6px; cursor: pointer; }

    .table-wrap { overflow: auto; border: 1px solid var(--border); border-radius: 12px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead { position: sticky; top: 0; background: #0e141c; }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: top; }
    th { text-align: left; white-space: nowrap; color: var(--muted); font-weight: 600; cursor: pointer; user-select: none; }
    th .sort { opacity: .8; font-size: 11px; margin-left: 6px; }
    tr:hover td { background: rgba(77,163,255,0.06); }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; color: var(--muted); }
    .status { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 10px; border: 1px solid var(--border); }
    .dot { width: 8px; height: 8px; border-radius: 999px; background: var(--ok); }

    .error { background: rgba(255,90,95,.08); border: 1px solid rgba(255,90,95,.35); color: #ffd7d9; padding: 12px; border-radius: 12px; }

    .footer-note { color: var(--muted); font-size: 12px; margin-top: 8px; }

    /* Responsive columns when hay campos largos */
    .cell-long { max-width: 520px; overflow: hidden; text-overflow: ellipsis; }
    .wrap-text { white-space: pre-wrap; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Lenguaje controlado â€“ VisualizaciÃ³n</h1>
      <div class="sub">Base funcionando + bÃºsqueda global y filtros dinÃ¡micos. Luego podemos aÃ±adir relaciones y fichas de detalle.</div>

      <div class="toolbar">
        <div class="left">
          <span id="status" class="status"><span class="dot"></span><span>Cargandoâ€¦</span></span>
          <span id="count" class="badge">0 registros</span>
          <span id="fields" class="badge">0 campos</span>
        </div>
        <input id="q" type="text" placeholder="Buscar en todos los camposâ€¦" />
        <div class="right">
          <button id="addFilter">+ Filtro</button>
          <button id="clearFilters">Limpiar</button>
          <button id="reload">Recargar</button>
          <button id="toggleRaw">Ver registro ejemplo</button>
        </div>
      </div>

      <div id="filters" class="filters"></div>
    </div>
  </header>

  <main class="wrap" style="margin-top:16px;">
    <section class="panel">
      <div class="table-wrap">
        <table id="tbl">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="footer-note mono">
        Fuente JSON: <span id="dataUrl"></span>
      </div>
    </section>

    <section id="rawBox" class="panel" style="margin-top:12px; display:none;">
      <div class="mono" id="rawSample"></div>
    </section>

    <section id="errorBox" style="display:none; margin-top:12px;">
      <div class="error" id="errorMsg"></div>
    </section>

    <section class="footer-note" style="margin-top:12px;">
      <details>
        <summary>Â¿CÃ³mo conectar otro archivo?</summary>
        <div style="margin-top:8px;">
          Edita la constante <code class="mono">DATA_URL</code> al inicio del script o coloca el archivo <code class="mono">lenguaje.json</code> junto a este <em>index.html</em>.
        </div>
      </details>
    </section>
  </main>

  <script>
    // ðŸ”— Ajusta esta ruta si tu JSON estÃ¡ en otra carpeta o con otro nombre
    const DATA_URL = './lenguaje.json';

    // ðŸ“¦ Estado
    let RAW = [];        // dataset completo
    let VIEW = [];       // dataset filtrado/ordenado
    let COLUMNS = [];    // columnas detectadas
    let SORT = { key: null, dir: 1 }; // 1 asc / -1 desc

    // ðŸ§  Helpers
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const el = (tag, props = {}, children = []) => { const n = document.createElement(tag); Object.assign(n, props); for (const c of children) n.append(c); return n; };
    const deb = (fn, ms=250) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; };

    const statusOk = (msg) => $('#status').innerHTML = '<span class="dot"></span><span>'+msg+'</span>';
    const statusWarn = (msg) => $('#status').innerHTML = '<span class="dot" style="background:var(--warn)"></span><span>'+msg+'</span>';
    const statusErr = (msg) => $('#status').innerHTML = '<span class="dot" style="background:var(--err)"></span><span>'+msg+'</span>';

    function showError(message, detail) {
      statusErr('Error al cargar');
      $('#errorBox').style.display = 'block';
      $('#errorMsg').textContent = message + (detail ? ('\n\n' + detail) : '');
      console.error('[JSON error]', message, detail);
    }

    function normalizeArray(data) {
      if (Array.isArray(data)) return data;
      if (data && Array.isArray(data.items)) return data.items;
      if (data && Array.isArray(data.data)) return data.data;
      return null;
    }

    function extractColumns(rows) {
      const cols = new Set();
      for (const r of rows) Object.keys(r || {}).forEach(k => cols.add(k));
      return Array.from(cols);
    }

    function uniqueValues(rows, key) {
      const s = new Set();
      for (const r of rows) {
        const v = r?.[key];
        if (v === undefined || v === null || v === '') continue;
        if (Array.isArray(v)) v.forEach(x => s.add(String(x)));
        else s.add(String(v));
      }
      return Array.from(s).sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));
    }

    function compare(a,b) {
      // num-aware string compare
      const na = parseFloat(a), nb = parseFloat(b);
      const aNum = !Number.isNaN(na) && String(a).trim() !== '' && /^-?\d+(\.\d+)?$/.test(String(a).trim());
      const bNum = !Number.isNaN(nb) && String(b).trim() !== '' && /^-?\d+(\.\d+)?$/.test(String(b).trim());
      if (aNum && bNum) return na - nb;
      return String(a).localeCompare(String(b),'es',{sensitivity:'base'});
    }

    function renderTable(rows) {
      const thead = $('#tbl thead');
      const tbody = $('#tbl tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';

      if (!rows || !rows.length) {
        statusWarn('0 registros');
        $('#count').textContent = '0 registros';
        return;
      }

      const trh = el('tr');
      for (const c of COLUMNS) {
        const th = el('th', { textContent: c });
        const sortIcon = el('span', { className: 'sort', textContent: SORT.key === c ? (SORT.dir === 1 ? 'â–²' : 'â–¼') : 'â‡…' });
        th.append(sortIcon);
        th.addEventListener('click', () => {
          if (SORT.key === c) SORT.dir *= -1; else { SORT.key = c; SORT.dir = 1; }
          applyAll();
        });
        trh.append(th);
      }
      thead.append(trh);

      const frag = document.createDocumentFragment();
      for (const r of rows) {
        const tr = el('tr');
        for (const c of COLUMNS) {
          let v = r[c];
          if (typeof v === 'object' && v !== null) {
            try { v = JSON.stringify(v); } catch { v = String(v); }
            tr.append(el('td', { textContent: v, className: 'cell-long' }));
          } else {
            const s = v == null ? '' : String(v);
            tr.append(el('td', { textContent: s, className: (s.length > 120 ? 'cell-long wrap-text' : '') }));
          }
        }
        frag.append(tr);
      }
      tbody.append(frag);

      $('#count').textContent = rows.length + ' registros';
      $('#fields').textContent = COLUMNS.length + ' campos';
      statusOk('Listo');
    }

    // ðŸ”Ž BÃºsqueda global
    function matchesSearch(row, q) {
      if (!q) return true;
      const tokens = q.toLowerCase().split(/\s+/).filter(Boolean);
      if (!tokens.length) return true;
      const haystack = COLUMNS.map(k => {
        const v = row[k];
        if (v == null) return '';
        return typeof v === 'object' ? JSON.stringify(v).toLowerCase() : String(v).toLowerCase();
      }).join(' | ');
      return tokens.every(t => haystack.includes(t));
    }

    // ðŸ§° Filtros dinÃ¡micos
    const ACTIVE_FILTERS = []; // {id, field, value, mode}

    function newFilterChip(id) {
      const chip = el('div', { className: 'filter-chip', dataset: { id } });

      const fieldSel = el('select');
      fieldSel.append(el('option', { value: '', textContent: 'â€” campo â€”' }));
      for (const c of COLUMNS) fieldSel.append(el('option', { value: c, textContent: c }));

      const modeSel = el('select');
      ['es','contiene','empieza'].forEach(m => modeSel.append(el('option', { value: m, textContent: m })));

      const valueWrap = el('span'); // se reemplaza por select o input segÃºn cardinalidad

      const del = el('button', { className: 'chip-del', title: 'Quitar', textContent: 'âœ•' });

      const rebuildValueInput = () => {
        const field = fieldSel.value;
        valueWrap.innerHTML = '';
        if (!field) { valueWrap.append(el('input', { type:'text', placeholder: 'valorâ€¦', disabled: true })); return; }
        const values = uniqueValues(RAW, field);
        if (values.length > 120) {
          // muchos valores â†’ input libre
          valueWrap.append(el('input', { type:'text', placeholder: 'valorâ€¦' }));
        } else {
          const vsel = el('select');
          vsel.append(el('option', { value: '', textContent: 'â€” valor â€”' }));
          values.forEach(v => vsel.append(el('option', { value: v, textContent: v })));
          valueWrap.append(vsel);
        }
      };

      fieldSel.addEventListener('change', () => { rebuildValueInput(); applyAll(); });
      modeSel.addEventListener('change', () => applyAll());
      del.addEventListener('click', () => {
        chip.remove();
        const idx = ACTIVE_FILTERS.findIndex(f => f.id === id);
        if (idx >= 0) ACTIVE_FILTERS.splice(idx,1);
        applyAll();
      });

      // Observa cambios en el value (sea select o input)
      const obs = new MutationObserver(() => {
        const inp = valueWrap.querySelector('select, input');
        if (!inp) return;
        inp.addEventListener('input', deb(applyAll, 100));
        inp.addEventListener('change', applyAll);
      });
      obs.observe(valueWrap, { childList: true });

      rebuildValueInput();
      chip.append(fieldSel, modeSel, valueWrap, del);
      return chip;
    }

    function readFiltersFromUI() {
      const chips = $$('#filters .filter-chip');
      const filters = [];
      for (const chip of chips) {
        const field = chip.querySelector('select').value; // primer select = field
        const selects = chip.querySelectorAll('select');
        const mode = selects[1]?.value || 'es';
        const valEl = chip.querySelector('select:last-of-type, input');
        const value = valEl?.value ?? '';
        if (field && value) filters.push({ field, mode, value });
      }
      return filters;
    }

    function matchesFilters(row, filters) {
      for (const f of filters) {
        const v = row?.[f.field];
        const s = v == null ? '' : (typeof v === 'object' ? JSON.stringify(v) : String(v));
        const target = String(f.value);
        if (f.mode === 'es' && s !== target) return false;
        if (f.mode === 'contiene' && !s.toLowerCase().includes(target.toLowerCase())) return false;
        if (f.mode === 'empieza' && !s.toLowerCase().startsWith(target.toLowerCase())) return false;
      }
      return true;
    }

    function applyAll() {
      const q = $('#q').value.trim();
      const filters = readFiltersFromUI();
      VIEW = RAW.filter(r => matchesSearch(r, q) && matchesFilters(r, filters));

      // Orden
      if (SORT.key) {
        VIEW.sort((a,b) => SORT.dir * compare(a?.[SORT.key], b?.[SORT.key]));
      }
      renderTable(VIEW);
    }

    async function loadData() {
      $('#errorBox').style.display = 'none';
      statusOk('Cargandoâ€¦');
      $('#dataUrl').textContent = DATA_URL;
      try {
        const res = await fetch(DATA_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + res.statusText);
        const json = await res.json();
        const arr = normalizeArray(json);
        if (!arr) {
          showError('El JSON no es un array de objetos ni contiene {items:[â€¦]} o {data:[â€¦]}.' , 'Estructura recibida: ' + Object.keys(json || {}).join(', '));
          return;
        }
        RAW = arr;
        COLUMNS = extractColumns(RAW);
        // Reinicia filtros UI
        $('#filters').innerHTML = '';
        SORT = { key: null, dir: 1 };
        $('#q').value = '';
        VIEW = [...RAW];
        renderTable(VIEW);
        $('#rawSample').textContent = JSON.stringify(RAW[0] || {}, null, 2);
      } catch (e) {
        showError('No se pudo leer el archivo JSON en "' + DATA_URL + '".', e.message);
      }
    }

    // ðŸŽ›ï¸ Eventos UI
    $('#reload').addEventListener('click', loadData);
    $('#toggleRaw').addEventListener('click', () => {
      const box = $('#rawBox');
      box.style.display = box.style.display === 'none' ? 'block' : 'none';
    });
    $('#q').addEventListener('input', deb(applyAll, 200));
    $('#addFilter').addEventListener('click', () => {
      const id = crypto.randomUUID?.() || String(Date.now() + Math.random());
      $('#filters').append(newFilterChip(id));
    });
    $('#clearFilters').addEventListener('click', () => {
      $('#filters').innerHTML = '';
      $('#q').value = '';
      SORT = { key: null, dir: 1 };
      applyAll();
    });

    // ðŸš€ Inicio
    loadData();
  </script>
</body>
</html>



